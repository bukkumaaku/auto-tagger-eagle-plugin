name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            platform_name: win32
            keep_arch: x64
            zip_name: auto-tagger-eagle-plugin-win-x64.zip
          - os: macos-14
            platform_name: darwin
            keep_arch: arm64
            zip_name: auto-tagger-eagle-plugin-mac-arm64.zip

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        # 只安装运行需要的包，不安装 devDependencies
        run: npm install --omit=dev

      # === Windows 清理步骤 (删除多余架构) ===
      - name: Cleanup for Windows
        if: runner.os == 'Windows'
        run: |
          # 1. 删除 fluent-ffmpeg 的测试覆盖率文件
          if (Test-Path "node_modules/fluent-ffmpeg/coverage") { Remove-Item "node_modules/fluent-ffmpeg/coverage" -Recurse -Force }
          
          # 2. onnxruntime 清理: 只保留 win32/x64
          $BasePath = "node_modules/onnxruntime-node/bin/napi-v6"
          Remove-Item "$BasePath/darwin" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$BasePath/linux" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$BasePath/win32/arm64" -Recurse -Force -ErrorAction SilentlyContinue
          # 顺便清理一下 .bin 快捷方式，Windows下用户用不到
          if (Test-Path "node_modules/.bin") { Remove-Item "node_modules/.bin" -Recurse -Force }

      # === macOS 清理步骤 (删除多余架构) ===
      - name: Cleanup for macOS
        if: runner.os == 'macOS'
        run: |
          rm -rf node_modules/fluent-ffmpeg/coverage
          
          # onnxruntime 清理: 只保留 darwin/arm64
          BASE_PATH="node_modules/onnxruntime-node/bin/napi-v6"
          rm -rf "$BASE_PATH/linux"
          rm -rf "$BASE_PATH/win32"
          rm -rf "$BASE_PATH/darwin/x64"
          
          # 清理 .bin
          rm -rf node_modules/.bin

      # === Windows 打包 (排除开发文件) ===
      - name: Zip for Windows
        if: runner.os == 'Windows'
        run: |
          # -xr! 表示递归排除文件
          # 排除 git相关, github action配置, lock文件
          7z a -tzip -mx=9 ${{ matrix.zip_name }} . `
            '-xr!.git' `
            '-xr!.github' `
            '-xr!.gitignore' `
            '-xr!.gitattributes' `
            '-xr!bun.lock' `
            '-xr!bun.lockb' `
            '-xr!package-lock.json' `
            '-xr!.DS_Store'

      # === macOS 打包 (排除开发文件) ===
      - name: Zip for macOS
        if: runner.os == 'macOS'
        run: |
          # -x 后面跟通配符排除模式
          zip -9 -r ${{ matrix.zip_name }} . \
            -x "*.git/*" \
            -x "*.github/*" \
            -x ".gitignore" \
            -x ".gitattributes" \
            -x "bun.lock*" \
            -x "package-lock.json" \
            -x ".DS_Store"

      - name: Upload binaries to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ matrix.zip_name }}
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: true
