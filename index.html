<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
        />
        <script src="js/lib/vue.global.js"></script>
        <script src="js/lib/naiveui.js"></script>
        <script src="js/utils/tagset.js"></script>
        <script src="js/utils/tool.js"></script>
        <script src="js/utils/download-models.js"></script>
        <script src="js/plugin.js"></script>
        <style>
            .questionMark {
                width: 19px;
                height: 19px;
                margin-right: 5px;
            }
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
            }
            #app {
                width: 90%;
                height: fit-content;
            }
            @media (max-width: 800px) {
                #app {
                    max-width: 600px;
                }
            }
        </style>
    </head>

    <body>
        <div id="app">
            <n-config-provider :theme="theme">
                <n-space
                    justify="space-between"
                    style="
                        width: 100%;
                        height: 30px;
                        position: fixed;
                        top: 0px;
                        left: 0px;
                        -webkit-app-region: drag;
                        z-index: 10000;
                    "
                >
                    <n-thing
                        style="
                            height: 30px;
                            line-height: 30px;
                            margin-left: 10px;
                        "
                        >è‡ªåŠ¨æ ‡ç­¾</n-thing
                    >
                    <!-- æœ€å°åŒ–å’Œå…³é—­æŒ‰é’® -->
                    <n-thing>
                        <n-button
                            @click="handleMinimize"
                            size="small"
                            type="text"
                            style="-webkit-app-region: no-drag"
                        >
                            <img
                                src="./images/min.png"
                                style="width: 18px; height: 18px"
                            />
                        </n-button>
                        <n-button
                            @click="handleClose"
                            size="small"
                            type="text"
                            style="-webkit-app-region: no-drag"
                        >
                            <img
                                src="./images/close.png"
                                style="width: 18px; height: 18px"
                            />
                        </n-button>
                    </n-thing>
                </n-space>
                <n-divider
                    style="position: fixed; top: 5px; left: 0px; width: 100%"
                ></n-divider>
                <n-form
                    :model="formData"
                    label-placement="left"
                    label-width="auto"
                    style="
                        width: fit-content;
                        margin: auto auto;
                        position: relative;
                        margin-top: 30px;
                    "
                >
                    <n-form-item label="è¿›åº¦" path="modelName">
                        <n-thing>{{ allItem }}/{{ completeItem }}</n-thing>
                        &nbsp;&nbsp;
                        <n-progress
                            type="line"
                            :percentage="Number((completeItem / allItem * 100).toFixed(2))"
                            indicator-placement="inside"
                        />
                    </n-form-item>
                    <!-- æ¨¡å‹ä½ç½® -->
                    <n-form-item label="æ¨¡å‹ä½ç½®" path="modelPath">
                        <n-select
                            v-model:value="formData.modelPath"
                            :options="options"
                        />
                        <n-button @click="downloadModel">ä¸‹è½½æ¨¡å‹</n-button>
                    </n-form-item>
                    <!-- é˜ˆå€¼ -->
                    <n-form-item label="é˜ˆå€¼" path="threshold"
                        ><n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            é˜ˆå€¼è¶Šé«˜ï¼Œæ ‡ç­¾è¶Šå°‘ï¼Œä½†æ˜¯æ ‡ç­¾å‡†ç¡®ç‡é«˜
                            <br />
                            é˜ˆå€¼è¶Šä½ï¼Œæ ‡ç­¾è¶Šå¤šï¼Œä½†æ˜¯æ ‡ç­¾å‡†ç¡®ç‡ä½
                        </n-tooltip>
                        <n-input-number
                            v-model:value="formData.threshold"
                            :min="0"
                            :max="1"
                            :step="0.01"
                        />
                    </n-form-item>
                    <!-- æ­¥æ•° -->
                    <n-form-item label="æ‰¹æ¬¡å¤§å°" path="steps">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            æ¯æ‰¹æ¬¡å¤„ç†å›¾ç‰‡çš„æ•°é‡ï¼Œå»ºè®®ä¸è¦å¤ªå¤§
                        </n-tooltip>
                        <n-input-number
                            v-model:value="formData.steps"
                            :min="1"
                            :max="40"
                        />
                    </n-form-item>
                    <!-- è¿‡æ»¤æ ‡ç­¾ -->
                    <n-form-item label="è¿‡æ»¤æ ‡ç­¾" path="filterTags">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            è¢«è¿‡æ»¤çš„æ ‡ç­¾å°†ä¸ä¼šå†™å…¥æ–‡ä»¶çš„æ ‡ç­¾ç»„ä¸­
                        </n-tooltip>
                        <n-select
                            filterable
                            multiple
                            tag
                            :show="false"
                            :show-arrow="false"
                            v-model:value="formData.filterTags"
                            placeholder="è¾“å…¥è¿‡æ»¤çš„æ ‡ç­¾ï¼ˆè‹±è¯­ï¼‰ï¼Œå›è½¦ç¡®è®¤"
                        />
                    </n-form-item>
                    <!-- æ˜¯å¦è¦†å†™ -->
                    <n-form-item label="æ˜¯å¦è¦†å†™" path="overwrite">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            ä¸è¦†å†™ï¼šç›´æ¥è·³è¿‡æœ‰æ ‡ç­¾æ–‡ä»¶ï¼ˆè‹¥å¤§é‡æ–‡ä»¶å·²æœ‰æ ‡ç­¾ï¼Œé€Ÿåº¦æœ€å¿«ï¼‰<br />
                            è¦†å†™ï¼šè‹¥æ˜¯æœ‰æ ‡ç­¾åˆ™è¿›è¡Œè¦†å†™ï¼ˆæ—¶é—´æ¶ˆè€—è¾ƒé«˜ï¼‰<br />
                            åˆå¹¶ï¼šè‹¥æ˜¯æœ‰æ ‡ç­¾åˆ™è¿›è¡Œåˆå¹¶ï¼ˆæ—¶é—´æ¶ˆè€—æœ€é«˜ï¼‰
                        </n-tooltip>
                        <n-radio-group
                            v-model:value="formData.overwrite"
                            name="overwrite"
                        >
                            <n-space>
                                <n-radio value="nocover">ä¸è¦†å†™</n-radio>
                                <n-radio value="cover">è¦†å†™</n-radio>
                                <n-radio value="merge">åˆå¹¶</n-radio>
                            </n-space>
                        </n-radio-group>
                    </n-form-item>
                    <!-- æ˜¯å¦è¯†åˆ«è§†é¢‘ -->
                    <n-form-item label="è§†é¢‘æ ‡ç­¾" path="readVideo">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            å°†è¯»å–è§†é¢‘å†…å®¹ï¼Œå¹¶å¯¹1%ã€20%ã€40%ã€60%ã€80%ã€99%ä½ç½®çš„å›¾åƒè¿›è¡Œæ ‡ç­¾è¯†åˆ«<br />
                            å¯¹è§†é¢‘æ–‡ä»¶è¿›è¡Œæ ‡ç­¾é€Ÿåº¦å°†å¤§å¹…åº¦é™ä½<br />
                            éœ€è¦æå‰å®‰è£…æ’ä»¶ä¸­å¿ƒçš„ffmpeg
                        </n-tooltip>
                        <n-radio-group
                            v-model:value="formData.readVideo"
                            name="readVideo"
                        >
                            <n-space>
                                <n-radio value="noread">ä¸è¯»å–è§†é¢‘å†…å®¹</n-radio>
                                <n-radio value="read">è¯»å–å¹¶æ ‡ç­¾</n-radio>
                            </n-space>
                        </n-radio-group>
                    </n-form-item>
                    <!-- æ ‡ç­¾è¯­è¨€é€‰æ‹© -->
                    <n-form-item label="æ ‡ç­¾è¯­è¨€" path="language">
                        <n-radio-group
                            v-model:value="formData.language"
                            name="language"
                        >
                            <n-space>
                                <n-radio value="zh">ä¸­æ–‡</n-radio>
                                <n-radio value="en">è‹±æ–‡</n-radio>
                                <n-radio value="mix">ä¸­æ–‡+è‹±æ–‡</n-radio>
                            </n-space>
                        </n-radio-group>
                    </n-form-item>
                    <!-- åˆ†éš”ç¬¦ -->
                    <n-form-item label="åˆ†éš”ç¬¦" path="splitter">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            ä¸­æ–‡å’Œè‹±æ–‡æ ‡ç­¾å…±å­˜æ‰éœ€è¦å¼€å¯åˆ†éš”ç¬¦
                        </n-tooltip>
                        <n-input
                            v-model:value="formData.splitter"
                            :placeholder="formData.language === 'mix' ? 'è¯·è¾“å…¥åˆ†éš”ç¬¦' : 'ä¸­æ–‡å’Œè‹±æ–‡æ ‡ç­¾å…±å­˜æ‰éœ€è¦å¼€å¯åˆ†éš”ç¬¦'"
                            :disabled="formData.language !== 'mix'"
                        />
                    </n-form-item>
                    <!-- å¯åŠ¨è‡ªåŠ¨æ‰“æ ‡ -->
                    <n-form-item label="å¯åŠ¨åæ‰“æ ‡" path="autotagger">
                        <n-tooltip trigger="hover">
                            <template #trigger>
                                <div
                                    v-html="questionMark"
                                    class="questionMark"
                                ></div>
                            </template>
                            æ‰“å¼€è½¯ä»¶åè‡ªåŠ¨å¯¹æœªæ‰“æ ‡å›¾ç‰‡æ‰“æ ‡ï¼Œæ‰“æ ‡å‚æ•°å¥—ç”¨ä¸Šä¸€æ¬¡æ‰“æ ‡å‚æ•°<br />
                            æ ‡ç­¾è¦†å†™ä½¿ç”¨ä¸è¦†å†™
                        </n-tooltip>
                        <n-switch v-model:value="formData.autotagger" />
                    </n-form-item>
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div
                        style="
                            display: flex;
                            gap: 10px;
                            justify-content: flex-end;
                        "
                    >
                        <n-button type="primary" @click="handleSubmit(false)"
                            >ç¡®å®š</n-button
                        >
                        <n-button @click="handleReset">æ¢å¤é»˜è®¤</n-button>
                    </div>
                </n-form>
                <n-modal
                    v-model:show="showModal"
                    preset="card"
                    title="ä¸‹è½½æ¨¡å‹èµ„æº"
                    :mask-closable="!isDownloading"
                    :close-on-esc="!isDownloading"
                    :closable="!isDownloading"
                    :on-close="handleCloseModal"
                >
                    <n-space vertical size="large">
                        <n-card embedded :bordered="false" size="small">
                            <n-space vertical>
                                <div class="setting-row">
                                    <span class="label">é€‰æ‹©æ¨¡å‹ï¼š</span>
                                    <n-select
                                        v-model:value="selectedModel"
                                        :options="modelOptions"
                                        :disabled="isDownloading"
                                        placeholder="è¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ¨¡å‹"
                                        style="width: 300px"
                                    />
                                </div>

                                <div class="setting-row">
                                    <span class="label">ä¸‹è½½æºï¼š</span>
                                    <n-radio-group
                                        v-model:value="downloadSource"
                                        :disabled="isDownloading"
                                    >
                                        <n-radio-button value="direct">
                                            HuggingFace ç›´è¿
                                        </n-radio-button>
                                        <n-radio-button value="mirror">
                                            å›½å†…é•œåƒ (HF-Mirror)
                                        </n-radio-button>
                                    </n-radio-group>
                                </div>
                            </n-space>
                        </n-card>

                        <div
                            v-if="!isDownloading"
                            style="display: flex; justify-content: flex-end"
                        >
                            <n-button
                                type="primary"
                                size="large"
                                @click="startDownload"
                                :disabled="!selectedModel"
                            >
                                <template #icon>
                                    <n-icon
                                        ><div class="i-download-icon">
                                            â¬‡
                                        </div></n-icon
                                    >
                                </template>
                                å¼€å§‹ä¸‹è½½
                            </n-button>
                        </div>

                        <n-collapse-transition :show="isDownloading">
                            <n-card
                                title="ä¸‹è½½è¿›åº¦"
                                embedded
                                :bordered="false"
                                size="small"
                            >
                                <template #header-extra>
                                    <n-tag type="info" size="small" round>
                                        é€Ÿåº¦: {{ currentSpeed }}
                                    </n-tag>
                                </template>

                                <n-space vertical size="medium">
                                    <div class="progress-item">
                                        <div class="progress-label">
                                            <span>ğŸ“¦ selected_tags.csv</span>
                                            <span class="percentage"
                                                >{{ progressTags }}%</span
                                            >
                                        </div>
                                        <n-progress
                                            type="line"
                                            :percentage="progressTags"
                                            :indicator-placement="'inside'"
                                            processing
                                            status="success"
                                        />
                                    </div>

                                    <div class="progress-item">
                                        <div class="progress-label">
                                            <span>ğŸ§  model.onnx</span>
                                            <span class="percentage"
                                                >{{ progressModel }}%</span
                                            >
                                        </div>
                                        <n-progress
                                            type="line"
                                            :percentage="progressModel"
                                            :indicator-placement="'inside'"
                                            processing
                                            :status="progressModel === 100 ? 'success' : 'info'"
                                        />
                                    </div>
                                </n-space>

                                <div class="download-footer">
                                    <n-spin
                                        size="small"
                                        v-if="progressModel < 100"
                                    />
                                    <span style="margin-left: 8px">
                                        {{ progressModel < 100 ?
                                        'æ­£åœ¨ä¸‹è½½èµ„æºï¼Œè¯·å‹¿å…³é—­çª—å£...' :
                                        'ä¸‹è½½å®Œæˆï¼æ­£åœ¨æ ¡éªŒæ–‡ä»¶...' }}
                                    </span>
                                </div>
                            </n-card>
                        </n-collapse-transition>
                    </n-space>
                </n-modal>
            </n-config-provider>
        </div>
        <script>
            const { createApp, ref, h } = Vue;
            // å¼•ç”¨é€šçŸ¥ç»„ä»¶
            const sendNotification = naive.createDiscreteApi([
                "notification",
                "dialog",
                "modal",
            ]);

            let config = {};
            async function main() {
                // è·å–é…ç½®
                config = await getConfig();
                const originalConfig = JSON.parse(JSON.stringify(config));
                createApp({
                    setup() {
                        const theme = naive.darkTheme;
                        const formData = ref(config);
                        // æäº¤å¤„ç†
                        const handleSubmit = async (isAll = false) => {
                            if (formData.value.modelPath === "") {
                                notification("è¯·é€‰æ‹©æ¨¡å‹è·¯å¾„");
                                return;
                            }
                            if (is_processing) {
                                notification("ä»æœ‰ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç­‰å¾…");
                                return;
                            }
                            is_processing = true;
                            await initialize(isAll);
                            await wait(500);
                            config = formData.value;
                            await setConfig(config);
                            await startGetTag(config);
                        };
                        // é‡ç½®è¡¨å•
                        const handleReset = () => {
                            formData.value = originalConfig;
                        };
                        const handleMinimize = async () => {
                            await eagle.window.minimize();
                        };
                        const handleClose = async () => {
                            await eagle.window.hide();
                        };
                        const downloadModel = async () => {};
                        const options = ref([]);
                        const allItem = ref(0);
                        const completeItem = ref(0);
                        const questionMark = ref(
                            `<img src="./images/img.icons8.png" class="questionMark">`
                        );
                        const showModal = ref(false);
                        const isDownloading = ref(false);
                        const downloadSource = ref("mirror");
                        const currentSpeed = ref("0 B/s");
                        const progressTags = ref(0);
                        const progressModel = ref(0);
                        const selectedModel = ref({
                            label: "wd-eva02-large-tagger-v3",
                            value: "wd-eva02-large-tagger-v3",
                            type: "wd",
                        });
                        const modelOptions = [
                            {
                                label: "wd-eva02-large-tagger-v3",
                                value: "wd-eva02-large-tagger-v3",
                                type: "wd",
                            },
                            {
                                label: "wd-vit-tagger-v3",
                                value: "wd-vit-tagger-v3",
                                type: "wd",
                            },
                            {
                                label: "wd-v1-4-moat-tagger-v2",
                                value: "wd-v1-4-moat-tagger-v2",
                                type: "wd",
                            },
                            {
                                label: "cl-tagger",
                                value: "cl-tagger",
                                type: "cl",
                            },
                        ];
                        const handleCloseModal = () => {
                            showModal.value = false;
                        };
                        const onProgress = (percentage, speed, type) => {
                            if (type === "model")
                                progressModel.value = percentage;
                            else progressTags.value = percentage;
                            currentSpeed.value = speed;
                        };
                        const startDownload = async () => {
                            isDownloading.value = true;
                            progressTags.value = 0;
                            progressModel.value = 0;
                            currentSpeed.value = "Connecting...";
                            await downloadFile(
                                selectedModel.value.value,
                                selectedModel.value.type,
                                onProgress
                            );
                        };
                        const finishDownload = async () => {
                            isDownloading.value = false;
                        };
                        window.options = options;
                        window.formData = formData;
                        window.allItem = allItem;
                        window.completeItem = completeItem;
                        window.handleSubmit = handleSubmit;
                        return {
                            formData,
                            handleSubmit,
                            handleReset,
                            options,
                            allItem,
                            completeItem,
                            questionMark,
                            theme,
                            handleClose,
                            handleMinimize,
                            downloadModel,
                            showModal,
                            isDownloading,
                            downloadSource,
                            currentSpeed,
                            progressTags,
                            progressModel,
                            modelOptions,
                            handleCloseModal,
                            startDownload,
                            selectedModel,
                        };
                    },
                })
                    .use(naive)
                    .mount("#app");
                await wait(1000);
                await autotaggerFun(config);
            }
            main();
        </script>
    </body>
</html>
