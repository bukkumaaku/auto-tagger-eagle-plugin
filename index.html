<!doctype html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
		<script src="js/lib/vue.global.js"></script>
		<script src="js/lib/naiveui.js"></script>
		<script src="js/utils/tagset.js"></script>
		<script src="js/plugin.js"></script>
		<style>
			.questionMark {
				width: 29px;
				height: 19px;
			}
		</style>
	</head>

	<body style="background-color: #ffffff">
		<div
			id="app"
			style="
				width: 600px;
				margin: auto auto;
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
				height: fit-content;
			"
		>
			<n-form
				:model="formData"
				label-placement="left"
				label-width="auto"
				style="max-width: 500px; margin: auto auto; position: relative"
			>
				<n-form-item label="进度" path="modelName">
					<span>{{ allItem }}/{{ completeItem }}</span> &nbsp;&nbsp;
					<n-progress
						type="line"
						:percentage="Number((completeItem / allItem * 100).toFixed(2))"
						indicator-placement="inside"
					/>
				</n-form-item>
				<!-- 模型位置 -->
				<n-form-item label="模型位置" path="modelPath">
					<n-select v-model:value="formData.modelPath" :options="options" />
				</n-form-item>
				<!-- 阈值 -->
				<n-form-item label="阈值" path="threshold">
					<n-input-number v-model:value="formData.threshold" :min="0" :max="1" :step="0.01" />
				</n-form-item>
				<!-- 步数 -->
				<n-form-item label="步数" path="steps">
					<n-tooltip trigger="hover">
						<template #trigger> <div v-html="questionMark" class="questionMark"></div> </template>
						每批次处理图片的数量，建议不要太大
					</n-tooltip>
					<n-input-number v-model:value="formData.steps" :min="1" :max="10" />
				</n-form-item>
				<!-- 过滤标签 -->
				<n-form-item label="过滤标签" path="filterTags">
					<n-tooltip trigger="hover">
						<template #trigger> <div v-html="questionMark" class="questionMark"></div> </template>
						被过滤的标签将不会写入文件的标签组中
					</n-tooltip>
					<n-select
						filterable
						multiple
						tag
						:show="false"
						:show-arrow="false"
						v-model:value="formData.filterTags"
						placeholder="输入过滤的标签（英语），回车确认"
					/>
				</n-form-item>
				<!-- 是否覆写 -->
				<n-form-item label="是否覆写" path="overwrite">
					<n-tooltip trigger="hover">
						<template #trigger> <div v-html="questionMark" class="questionMark"></div> </template>
						不覆写：若是有标签则不进行覆写<br />
						覆写：若是有标签则进行覆写<br />
						合并：若是有标签则进行合并
					</n-tooltip>
					<n-radio-group v-model:value="formData.overwrite" name="overwrite">
						<n-space>
							<n-radio value="nocover">不覆写</n-radio>
							<n-radio value="cover">覆写</n-radio>
							<n-radio value="merge">合并</n-radio>
						</n-space>
					</n-radio-group>
				</n-form-item>
				<!-- 标签语言选择 -->
				<n-form-item label="标签语言" path="language">
					<n-tooltip trigger="hover">
						<template #trigger> <div v-html="questionMark" class="questionMark"></div> </template>
						中文和英文标签共存才需要开启分隔符
					</n-tooltip>
					<n-radio-group v-model:value="formData.language" name="language">
						<n-space>
							<n-radio value="zh">中文</n-radio>
							<n-radio value="en">英文</n-radio>
							<n-radio value="mix">中文+英文</n-radio>
						</n-space>
					</n-radio-group>
				</n-form-item>
				<!-- 分隔符 -->
				<n-form-item label="分隔符" path="splitter">
					<n-input
						v-model:value="formData.splitter"
						:placeholder="formData.language === 'mix' ? '请输入分隔符' : '中文和英文标签共存才需要开启分隔符'"
						:disabled="formData.language !== 'mix'"
					/>
				</n-form-item>
				<!-- 操作按钮 -->
				<div style="display: flex; gap: 10px; justify-content: flex-end">
					<n-button type="primary" @click="handleSubmit">确定</n-button>
					<n-button @click="handleReset">恢复默认</n-button>
					<!-- <n-button @click="handleReFresh">刷新</n-button> -->
				</div>
			</n-form>
		</div>
		<script>
			const { createApp, ref } = Vue;

			const sendNotification = naive.createDiscreteApi(["notification"]);

			let config = {};
			async function main() {
				config = await getConfig();
				const originalConfig = JSON.parse(JSON.stringify(config));
				createApp({
					setup() {
						const formData = ref(config);
						// 提交处理
						const handleSubmit = async () => {
							if (formData.value.modelPath === "") {
								sendNotification.notification.error({ title: "请选择模型路径" });
								await eagle.notification.show({
									title: "错误",
									body: "请选择模型路径",
									mute: false,
									duration: 3000,
								});
								return;
							}
							if (allItem.value === completeItem.value) {
								//alert("所有文件已打标完成");
								sendNotification.notification.info({ title: "所有文件已打标完成" });
								await eagle.notification.show({
									title: "成功",
									body: "所有文件已打标完成",
									mute: false,
									duration: 3000,
								});
								return;
							}
							config = formData.value;
							await setConfig(config);
							console.log("提交数据:", formData.value);
							await startGetTag(config);
						};
						// 重置表单
						const handleReset = () => {
							formData.value = originalConfig;
						};
						const options = ref([]);
						const allItem = ref(0);
						const completeItem = ref(0);
						const questionMark = ref(`<svg
								xmlns="http://www.w3.org/2000/svg"
								xmlns:xlink="http://www.w3.org/1999/xlink"
								viewBox="0 0 19 19"
			                             style="margin-right:5px;margin-left:5px;margin-top: auto;margin-bottom: auto;width: 19px;height: 19px;"
							>
								<g fill="none">
									<path
										d="M10 2a8 8 0 1 1 0 16a8 8 0 0 1 0-16zm0 1a7 7 0 1 0 0 14a7 7 0 0 0 0-14zm0 10.5a.75.75 0 1 1 0 1.5a.75.75 0 0 1 0-1.5zm0-8a2.5 2.5 0 0 1 1.651 4.377l-.154.125l-.219.163l-.087.072a1.968 1.968 0 0 0-.156.149c-.339.36-.535.856-.535 1.614a.5.5 0 0 1-1 0c0-1.012.293-1.752.805-2.298a3.11 3.11 0 0 1 .356-.323l.247-.185l.118-.1A1.5 1.5 0 1 0 8.5 8a.5.5 0 0 1-1 .001A2.5 2.5 0 0 1 10 5.5z"
										fill="currentColor"
									></path>
								</g>
							</svg>`);
						const handleReFresh = () => {
							window.location.reload();
						};
						window.options = options;
						window.formData = formData;
						window.allItem = allItem;
						window.completeItem = completeItem;
						return {
							formData,
							handleSubmit,
							handleReset,
							options,
							handleReFresh,
							allItem,
							completeItem,
							questionMark,
						};
					},
				})
					.use(naive)
					.mount("#app");
			}
			main();

			//import * as aiTagger from "@/assets/index.js";
			// 表单数据
		</script>
	</body>
</html>
